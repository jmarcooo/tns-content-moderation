<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Labelling</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        .icon-svg { width: 14px; height: 14px; fill: currentColor; vertical-align: middle; margin-right: 4px; opacity: 0.7; }
        .back-nav { margin-bottom: 15px; color: var(--text-muted); cursor: pointer; display: inline-flex; align-items: center; gap: 5px; font-size: 0.9rem; text-decoration: none; }
        .back-nav:hover { color: var(--accent-blue); }
        .loading-count { opacity: 0.5; font-style: italic; }

        /* --- TABLE LAYOUT --- */
        /* Adjusted last column to auto to fit admin buttons */
        .grid-layout { display: grid; grid-template-columns: 130px 2.5fr 1fr 1fr auto; gap: 15px; align-items: center; }

        .list-header-row { padding: 0 20px; margin-bottom: 8px; }
        .list-header-row > div {
            font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
        }

        .col-action { display: flex; justify-content: flex-end; align-items: center; gap: 8px; }
        .col-completion { font-family: "Inter", monospace; font-size: 0.9rem; color: var(--text-main); font-weight: 500; }

        /* --- COMPACT ADMIN BUTTONS --- */
        .admin-actions { display: none; align-items: center; gap: 6px; padding-left: 8px; border-left: 1px solid var(--border-color); margin-left: 8px; }
        
        .btn-icon-compact {
            background: transparent; border: 1px solid var(--border-color); border-radius: 4px;
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-muted); transition: all 0.2s;
        }
        .btn-icon-compact:hover { background-color: var(--bg-canvas); color: var(--text-main); border-color: var(--accent-blue); }
        .btn-icon-compact.danger:hover { color: #cf222e; border-color: #cf222e; background-color: #fff5f5; }
        .btn-icon-compact svg { width: 16px; height: 16px; opacity: 0.8; }
        
    </style>
</head>
<body>

    <script src="sidebar.js"></script>

    <main class="main-content">
        
        <a href="moderation.html" class="back-nav">← Back to Dashboard</a>

        <div class="header">
            <h1>Content Labelling</h1>
            <div style="text-align: right; margin-left: 20px;">
                <span style="color:var(--text-muted); font-size:0.9rem;">Total Pending:</span>
                <strong id="header-total-pending" style="font-size:1.2rem; color:var(--text-header); margin-left:5px;">...</strong>
            </div>
        </div>

        <div class="queue-container list-mode">
            <div class="list-header-row grid-layout">
                <div class="col-tenant">SOURCE</div>
                <div class="col-name">QUEUE NAME</div>
                <div class="col-pending">PENDING</div>
                <div class="col-completion">COMPLETION RATE</div>
                <div class="col-action" style="padding-right: 10px;">ACTION</div>
            </div>

            <div id="queue-dynamic-post" class="queue-list-item grid-layout" onclick="window.location.href='labelling-review.html'">
                <div class="col-tenant"><span class="badge-tenant">Data Team</span></div>
                <div class="col-name">Dynamic Post Labelling</div>
                <div class="col-pending">842 <span class="sub-text">Items</span></div>
                <div class="col-completion">45%</div>
                <div class="col-action"><button class="btn-review">Start</button></div>
            </div>

            <div id="queue-video" class="queue-list-item grid-layout" onclick="window.location.href='video-labelling.html'">
                <div class="col-tenant"><span class="badge-tenant">TNS Team</span></div>
                <div class="col-name">Video Labelling</div>
                <div class="col-pending">
                    <span id="video-pending-count" class="loading-count">Loading...</span> <span class="sub-text">Items</span>
                </div>
                <div class="col-completion" id="video-completion-rate">--%</div>
                
                <div class="col-action">
                    <button class="btn-review">Start</button>
                    
                    <div class="admin-actions" id="admin-actions-video" onclick="event.stopPropagation()">
                        <button class="btn-icon-compact" title="Upload CSV" onclick="document.getElementById('csvInput-video').click()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        </button>
                        <input type="file" id="csvInput-video" accept=".csv" style="display:none" onchange="App.uploadCSV(this, '/api/video-tasks')">

                        <button class="btn-icon-compact danger" title="Wipe & Download" onclick="App.exportAndWipe('/api/video-tasks')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div id="queue-image" class="queue-list-item grid-layout" onclick="window.location.href='labelling-review.html'">
                <div class="col-tenant"><span class="badge-tenant">Data Team</span></div>
                <div class="col-name">Image Labelling</div>
                <div class="col-pending">420 <span class="sub-text">Items</span></div>
                <div class="col-completion">62%</div>
                <div class="col-action"><button class="btn-review">Start</button></div>
            </div>

            <div id="queue-text" class="queue-list-item grid-layout" onclick="window.location.href='labelling-review.html'">
                <div class="col-tenant"><span class="badge-tenant">Data Team</span></div>
                <div class="col-name">Text Labelling</div>
                <div class="col-pending">315 <span class="sub-text">Items</span></div>
                <div class="col-completion">33%</div>
                <div class="col-action"><button class="btn-review">Start</button></div>
            </div>
        </div>

    </main>

    <script src="auth.js"></script>
    <script>
        const user = Auth.requireLogin();

        const App = {
            init() {
                this.checkRoles();
                this.updateTotalPending();
                this.fetchVideoStats();
            },

            checkRoles() {
                // Hide Data Team queues for Moderators
                if (user.role === 'Moderator') {
                    const hiddenQueues = ['queue-dynamic-post', 'queue-image', 'queue-text'];
                    hiddenQueues.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.style.display = 'none';
                    });
                }
                // Show Admin Actions for Admins
                if (user.role === 'Admin') {
                    // Show actions specifically for Video queue (and others later)
                    document.getElementById('admin-actions-video').style.display = 'flex';
                }
            },

            updateTotalPending() {
                let total = 0;
                const rows = document.querySelectorAll('.queue-list-item');
                rows.forEach(row => {
                    if (row.style.display !== 'none') {
                        let countText = "";
                        if (row.id === 'queue-video') {
                             countText = document.getElementById('video-pending-count').innerText;
                        } else {
                             countText = row.querySelector('.col-pending').innerText;
                        }
                        if(countText.includes("Loading") || countText.includes("Error")) countText = "0";
                        const count = parseInt(countText.replace(/[^\d]/g, ''), 10) || 0;
                        total += count;
                    }
                });
                document.getElementById('header-total-pending').innerText = total.toLocaleString();
            },

            async fetchVideoStats() {
                const countSpan = document.getElementById('video-pending-count');
                const rateSpan = document.getElementById('video-completion-rate');
                if (!countSpan) return;

                try {
                    const res = await fetch('/api/video-tasks');
                    const data = await res.json();

                    if (data.remaining !== undefined) {
                        countSpan.innerText = data.remaining.toLocaleString();
                        countSpan.classList.remove('loading-count');
                        
                        const total = data.total || 0;
                        const completed = data.completed || 0;
                        let percentage = 0;
                        if (total > 0) percentage = Math.round((completed / total) * 100);
                        
                        rateSpan.innerText = `${percentage}%`;
                        if(percentage >= 80) rateSpan.style.color = '#238636';
                        else if (percentage >= 50) rateSpan.style.color = '#d29922';
                        else rateSpan.style.color = 'var(--text-main)';

                        this.updateTotalPending();
                    } 
                } catch (err) {
                    console.error("Failed to fetch video stats:", err);
                    countSpan.innerText = "Error";
                }
            },

            // --- ADMIN FUNCTIONS (Targeted) ---
            uploadCSV(input, apiUrl) {
                const file = input.files[0]; if(!file) return;
                
                // Prevent bubbling immediately just in case
                if(event) event.stopPropagation();

                Papa.parse(file, { header: true, skipEmptyLines: true, complete: async function(results) {
                    const tasks = []; 
                    results.data.forEach(row => { 
                        if (row.id && row.raw_media_url) {
                            tasks.push({ 
                                id: row.id.trim(), 
                                tenant: row.tenant||'', 
                                title: row.title||'', 
                                content: row.content||'', 
                                created_by: row.created_by||'', 
                                created_time: row.created_time||'', 
                                video_uid: row.video_uid||'', 
                                video_duration: row.video_duration||'', 
                                raw_media_url: row.raw_media_url.trim() 
                            });
                        }
                    });
                    
                    if (tasks.length === 0) { alert("❌ No valid rows found."); return; }
                    if (!confirm(`Ready to upload ${tasks.length} tasks to this queue?`)) return;
                    
                    try { 
                        const res = await fetch(apiUrl, { 
                            method: 'POST', 
                            headers: {'Content-Type': 'application/json'}, 
                            body: JSON.stringify({ tasks }) 
                        }); 
                        if(res.ok) { 
                            alert("✅ Uploaded successfully!"); 
                            location.reload(); 
                        } else {
                            alert("Upload failed."); 
                        }
                    } catch(err) { alert("Network Error"); }
                }, error: function(err) { alert("CSV Error"); } });
            },

            async exportAndWipe(apiUrl) { 
                if(event) event.stopPropagation();
                if(!confirm("⚠️ WARNING: This will DOWNLOAD all data and then DELETE it from this queue.\n\nAre you sure?")) return; 
                
                try { 
                    const res = await fetch(apiUrl, { method: 'DELETE' }); 
                    if(res.status===404){ alert("Queue is already empty."); return; } 
                    if(!res.ok) throw new Error("Failed"); 
                    
                    const b = await res.blob(); 
                    const u = window.URL.createObjectURL(b); 
                    const a = document.createElement('a'); 
                    a.href = u; 
                    a.download = `export_${new Date().toISOString().slice(0,10)}.csv`; 
                    document.body.appendChild(a); 
                    a.click(); 
                    document.body.removeChild(a); 
                    
                    alert("✅ Queue wiped and backup downloaded."); 
                    location.reload(); 
                } catch(e){ alert("Error during wipe/export."); } 
            }
        };

        App.init();
    </script>
</body>
</html>
