<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Labelling</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .icon-svg { width: 14px; height: 14px; fill: currentColor; vertical-align: middle; margin-right: 4px; opacity: 0.7; }
        .back-nav { margin-bottom: 15px; color: var(--text-muted); cursor: pointer; display: inline-flex; align-items: center; gap: 5px; font-size: 0.9rem; text-decoration: none; }
        .back-nav:hover { color: var(--accent-blue); }
        /* Added a loading style for the count */
        .loading-count { opacity: 0.5; font-style: italic; }
    </style>
</head>
<body>

    <script src="sidebar.js"></script>

    <main class="main-content">
        
        <a href="moderation.html" class="back-nav">‚Üê Back to Dashboard</a>

        <div class="header">
            <h1>Content Labelling</h1>
            <div style="text-align: right; margin-left: 20px;">
                <span style="color:var(--text-muted); font-size:0.9rem;">Total Pending:</span>
                <strong id="header-total-pending" style="font-size:1.2rem; color:var(--text-header); margin-left:5px;">...</strong>
            </div>
        </div>

        <div class="queue-container list-mode">
            <div class="list-header-row" style="grid-template-columns: 150px 2.5fr 1fr 100px;">
                <div class="col-tenant">SOURCE</div>
                <div class="col-name">QUEUE NAME</div>
                <div class="col-pending">PENDING</div>
                <div class="col-action">ACTION</div>
            </div>

            <div id="queue-dynamic-post" class="queue-list-item" style="grid-template-columns: 150px 2.5fr 1fr 100px;" onclick="window.location.href='labelling-review.html'">
                <div class="col-tenant"><span class="badge-tenant">Data Team</span></div>
                <div class="col-name">Dynamic Post Labelling</div>
                <div class="col-pending">842 <span class="sub-text">Items</span></div>
                <div class="col-action"><button class="btn-review">Start</button></div>
            </div>

            <div id="queue-video" class="queue-list-item" style="grid-template-columns: 150px 2.5fr 1fr 100px;" onclick="window.location.href='video-labelling.html'">
                <div class="col-tenant"><span class="badge-tenant">TNS Team</span></div>
                <div class="col-name">Video Labelling</div>
                <div class="col-pending"><span id="video-pending-count" class="loading-count">Loading...</span> <span class="sub-text">Items</span></div>
                <div class="col-action"><button class="btn-review">Start</button></div>
            </div>

            <div id="queue-image" class="queue-list-item" style="grid-template-columns: 150px 2.5fr 1fr 100px;" onclick="window.location.href='labelling-review.html'">
                <div class="col-tenant"><span class="badge-tenant">Data Team</span></div>
                <div class="col-name">Image Labelling</div>
                <div class="col-pending">420 <span class="sub-text">Items</span></div>
                <div class="col-action"><button class="btn-review">Start</button></div>
            </div>

            <div id="queue-text" class="queue-list-item" style="grid-template-columns: 150px 2.5fr 1fr 100px;" onclick="window.location.href='labelling-review.html'">
                <div class="col-tenant"><span class="badge-tenant">Data Team</span></div>
                <div class="col-name">Text Labelling</div>
                <div class="col-pending">315 <span class="sub-text">Items</span></div>
                <div class="col-action"><button class="btn-review">Start</button></div>
            </div>
        </div>

    </main>

    <script src="auth.js"></script>
    <script>
        const user = Auth.requireLogin();

        // --- 1. ROLE BASED VISIBILITY ---
        if (user.role === 'Moderator') {
            const hiddenQueues = ['queue-dynamic-post', 'queue-image', 'queue-text'];
            hiddenQueues.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }

        // --- 2. DYNAMIC TOTAL PENDING CALCULATION ---
        function updateTotalPending() {
            let total = 0;
            const rows = document.querySelectorAll('.queue-list-item');
            
            rows.forEach(row => {
                // Only count rows that are visible
                if (row.style.display !== 'none') {
                    const pendingDiv = row.querySelector('.col-pending');
                    // We only want the direct text node or the span that holds the number, not the "Items" sub-text
                    // Note: The Video queue uses a specific span ID now.
                    let countText = "";
                    if (row.id === 'queue-video') {
                         countText = document.getElementById('video-pending-count').innerText;
                    } else {
                         // For hardcoded ones, just grab the raw text and clean it
                         countText = pendingDiv.innerText;
                    }

                    // If it says "Loading...", treat it as 0 for now
                    if(countText.includes("Loading")) countText = "0";

                    // Remove commas and non-digits, then parse
                    const count = parseInt(countText.replace(/[^\d]/g, ''), 10) || 0;
                    total += count;
                }
            });

            document.getElementById('header-total-pending').innerText = total.toLocaleString();
        }


        // --- 3. FETCH REAL DATABASE COUNT FOR VIDEO ---
        async function fetchVideoCount() {
            const countSpan = document.getElementById('video-pending-count');
            if (!countSpan || user.role !== 'Moderator' && user.role !== 'Admin') return;

            try {
                // We call the existing API. We don't need to provide a username just to get the total count.
                const res = await fetch('/api/video-tasks');
                const data = await res.json();

                if (data.remaining !== undefined) {
                    // Update text and remove loading class
                    countSpan.innerText = data.remaining.toLocaleString();
                    countSpan.classList.remove('loading-count');
                    
                    // IMPORTANT: Recalculate header total now that we have the real number
                    updateTotalPending();
                } else {
                     throw new Error("Invalid data format");
                }
            } catch (err) {
                console.error("Failed to fetch video tasks count:", err);
                countSpan.innerText = "Error";
                countSpan.style.color = "#cf222e";
            }
        }

        // Initialize
        // 1. Run calculation once immediately for hardcoded values (and placeholders)
        updateTotalPending();
        // 2. Fetch the real data for video queue
        fetchVideoCount();

    </script>
</body>
</html>
