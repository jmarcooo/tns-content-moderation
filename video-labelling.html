<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Labelling Task</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        /* --- GLOBAL & TYPOGRAPHY --- */
        :root {
            --bg-body: #f8f9fa; /* Softer background */
            --bg-card: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0d6efd;
            --tag-bg: #e7f1ff;
            --tag-text: #0c63e4;
            --header-height: 60px;
        }

        body.dark-mode {
            --bg-body: #0d1117;
            --bg-card: #161b22;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --tag-bg: #1f252e;
            --tag-text: #58a6ff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent page scroll */
        }

        /* --- HEADER --- */
        .app-header {
            height: var(--header-height);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .header-left, .header-right { display: flex; align-items: center; gap: 16px; }
        
        .app-title { font-weight: 700; font-size: 1.1rem; margin: 0; letter-spacing: -0.5px; }
        
        .back-link { 
            text-decoration: none; color: var(--text-muted); font-size: 0.85rem; font-weight: 500; 
            display: flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 6px;
            transition: background 0.2s;
        }
        .back-link:hover { background: var(--border-color); color: var(--text-main); }

        .stat-badge { font-size: 0.85rem; font-weight: 500; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
        .stat-value { color: var(--text-main); font-family: 'SFMono-Regular', Consolas, monospace; font-weight: 600; }

        /* --- MAIN LAYOUT (GRID) --- */
        .main-grid {
            display: grid;
            grid-template-columns: 260px 1fr 340px; /* Sidebar | Video | Controls */
            height: calc(100vh - var(--header-height));
            overflow: hidden;
        }

        /* COLUMN 1: SIDEBAR INFO */
        .col-sidebar {
            background: var(--bg-body);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* COLUMN 2: VIDEO STAGE */
        .col-video {
            background: #000; /* Theater mode feel */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .video-container {
            flex-grow: 1; /* Video takes max height */
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            padding: 20px;
        }
        
        video {
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            outline: none;
        }

        .video-meta-panel {
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            height: 30%; /* Fixed height for context */
            min-height: 150px;
            max-height: 300px;
            padding: 20px;
            overflow-y: auto;
        }

        /* COLUMN 3: CONTROL PANEL */
        .col-actions {
            background: var(--bg-card);
            border-left: 1px solid var(--border-color);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        /* --- COMPONENTS --- */
        
        /* Info Cards */
        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .info-label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .info-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.85rem; }
        .info-item:last-child { margin-bottom: 0; }
        .info-key { color: var(--text-muted); }
        .info-val { font-weight: 500; text-align: right; max-width: 130px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Copy Button */
        .copy-btn {
            background: transparent; border: none; cursor: pointer; color: var(--text-muted);
            padding: 2px; margin-right: 4px; display: flex; align-items: center;
        }
        .copy-btn:hover { color: var(--accent-color); }
        .copy-btn svg { width: 14px; height: 14px; }

        /* Label Buttons */
        .label-group { display: grid; gap: 8px; }
        .label-btn {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px;
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        .label-btn:hover { border-color: var(--accent-color); background: #fff; }
        .label-btn.active {
            background: #eef6fc; border-color: var(--accent-color); color: var(--accent-color);
        }
        .check-circle {
            width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--border-color);
            display: flex; align-items: center; justify-content: center; background: #fff;
        }
        .label-btn.active .check-circle { border-color: var(--accent-color); background: var(--accent-color); }
        .check-circle svg { width: 10px; height: 10px; fill: white; display: none; }
        .label-btn.active .check-circle svg { display: block; }

        /* Tags Input */
        .tags-wrapper {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            background: var(--bg-body);
            min-height: 80px;
            display: flex; flex-wrap: wrap; gap: 8px; align-content: flex-start;
            cursor: text;
        }
        .tags-wrapper:focus-within { border-color: var(--accent-color); background: #fff; box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1); }
        
        .tag-chip {
            background: var(--tag-bg); color: var(--tag-text);
            font-size: 0.85rem; font-weight: 500; padding: 4px 10px; border-radius: 16px;
            display: flex; align-items: center; gap: 6px;
        }
        .tag-remove { cursor: pointer; opacity: 0.6; font-size: 1rem; line-height: 1; }
        .tag-remove:hover { opacity: 1; }
        
        .tag-input-field {
            border: none; background: transparent; outline: none;
            flex-grow: 1; min-width: 100px; font-size: 0.9rem; color: var(--text-main);
        }

        /* Action Footer */
        .action-footer {
            margin-top: auto; /* Push to bottom */
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .btn-main {
            border: none; border-radius: 6px; padding: 12px;
            font-weight: 600; font-size: 0.9rem; cursor: pointer;
            transition: filter 0.2s;
        }
        .btn-submit { background: var(--accent-color); color: white; }
        .btn-submit:hover { filter: brightness(1.1); }
        .btn-save { background: var(--bg-body); border: 1px solid var(--border-color); color: var(--text-main); }
        .btn-save:hover { background: var(--border-color); }

        /* Loader & Empty States */
        #loader, #empty-state {
            position: fixed; top: var(--header-height); left: 0; right: 0; bottom: 0;
            background: var(--bg-body); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        /* Header Buttons */
        .btn-icon { background: none; border: 1px solid var(--border-color); border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 6px; color: var(--text-main); }
        .btn-icon:hover { background: var(--border-color); }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="header-left">
            <a href="#" onclick="VideoApp.handleBack(event)" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Back to Queue
            </a>
            <h1 class="app-title">Video Labelling</h1>
        </div>
        
        <div class="header-right">
            <div id="adminControls" style="display:none; gap:8px;">
                <button class="btn-icon" onclick="document.getElementById('csvInput').click()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Upload
                </button>
                <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="VideoApp.uploadCSV(this)">
                
                <button class="btn-icon" onclick="VideoApp.exportAndWipe()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Export
                </button>
            </div>
            <div class="stat-badge">
                <span>Time:</span> <span id="timer" class="stat-value">00:00:00</span>
            </div>
            <div class="stat-badge">
                <span>Count:</span> <span id="session-counter" class="stat-value">0</span>
            </div>
        </div>
    </header>

    <div id="loader">
        <div style="font-size: 1.2rem; font-weight: 500; margin-bottom: 10px;">âš¡ Fetching next task...</div>
        <div id="error-msg" style="color: #dc3545; display:none;"></div>
        <button id="retry-btn" onclick="VideoApp.fetchNextTask()" class="btn-save" style="margin-top:15px; display:none;">Retry</button>
    </div>

    <div id="empty-state" style="display: none;">
        <div style="font-size: 3rem; margin-bottom: 16px;">ðŸŽ‰</div>
        <h2 style="margin:0;">Queue Empty</h2>
        <p style="color: var(--text-muted);">Waiting for new batch upload.</p>
        <button onclick="VideoApp.fetchNextTask()" class="btn-save" style="margin-top:20px;">Refresh</button>
    </div>

    <div id="workbench" class="main-grid" style="display:none;">
        
        <aside class="col-sidebar">
            <div class="info-card">
                <div class="info-label">Task Details</div>
                <div class="info-item">
                    <span class="info-key">Post ID</span>
                    <div style="display:flex; align-items:center;">
                        <button class="copy-btn" onclick="VideoApp.copyText('info-id')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                        <span class="info-val" id="info-id">--</span>
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-key">Tenant</span>
                    <span class="info-val" id="info-tenant">--</span>
                </div>
                <div class="info-item">
                    <span class="info-key">Duration</span>
                    <span class="info-val" id="info-duration">--</span>
                </div>
            </div>

            <div class="info-card">
                <div class="info-label">Source Info</div>
                <div class="info-item">
                    <span class="info-key">Created By</span>
                    <div style="display:flex; align-items:center;">
                        <button class="copy-btn" onclick="VideoApp.copyText('info-creator')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                        <span class="info-val" id="info-creator">--</span>
                    </div>
                </div>
                <div class="info-item">
                    <span class="info-key">Time</span>
                    <span class="info-val" id="info-time">--</span>
                </div>
                <div class="info-item">
                    <span class="info-key">UID</span>
                    <div style="display:flex; align-items:center;">
                        <button class="copy-btn" onclick="VideoApp.copyText('info-uid')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                        <span class="info-val" id="info-uid">--</span>
                    </div>
                </div>
            </div>
        </aside>

        <main class="col-video">
            <div class="video-container">
                <video id="main-video" controls autoplay></video>
            </div>
            <div class="video-meta-panel">
                <div style="font-weight: 700; margin-bottom: 8px;">Video Title</div>
                <div id="text-top" style="margin-bottom: 16px; color: var(--text-main);"></div>
                
                <div style="font-weight: 700; margin-bottom: 8px;">Description / Content</div>
                <div id="text-bottom" style="color: var(--text-muted); line-height: 1.6; font-size: 0.9rem;"></div>
            </div>
        </main>

        <aside class="col-actions">
            <div>
                <div class="info-label" style="margin-bottom: 12px;">Categorization</div>
                <div class="label-group">
                    <div class="label-btn" onclick="VideoApp.selectLabel(this, 'Safe')">
                        <span>Safe</span>
                        <div class="check-circle"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                    </div>
                    <div class="label-btn" onclick="VideoApp.selectLabel(this, 'Low Risk')">
                        <span>Low Risk</span>
                        <div class="check-circle"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                    </div>
                    <div class="label-btn" onclick="VideoApp.selectLabel(this, 'High Risk')">
                        <span>High Risk</span>
                        <div class="check-circle"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                    </div>
                    <div class="label-btn" onclick="VideoApp.selectLabel(this, 'Critical')">
                        <span>Critical</span>
                        <div class="check-circle"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                    </div>
                </div>
            </div>

            <div style="flex-grow: 1; display: flex; flex-direction: column;">
                <div class="info-label" style="margin-bottom: 12px;">Tags</div>
                <div class="tags-wrapper" onclick="document.getElementById('tag-input').focus()">
                    <div id="tags-container" style="display: contents;"></div>
                    <input type="text" id="tag-input" class="tag-input-field" placeholder="Add tags..." onkeydown="VideoApp.handleTagInput(event)">
                </div>
            </div>

            <div class="action-footer">
                <button class="btn-main btn-save" onclick="VideoApp.submit(true)">Submit & Leave</button>
                <button class="btn-main btn-submit" onclick="VideoApp.submit(false)">Submit & Next</button>
            </div>
        </aside>

    </div>

    <script>
        const VideoApp = {
            selectedLabel: null, timer: 0, timerInterval: null, count: 0, currentTask: null, currentUser: null, isSubmitting: false, tags: [],
            
            init() {
                const userJson = localStorage.getItem('currentUser');
                if(!userJson) { window.location.href='login.html'; return; }
                this.currentUser = JSON.parse(userJson);
                if(this.currentUser.role === 'Admin') document.getElementById('adminControls').style.display = 'flex';
                
                window.addEventListener('beforeunload', () => {
                    if (this.currentTask && !this.isSubmitting) {
                        fetch('/api/video-tasks', { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: this.currentTask.internal_id }), keepalive: true });
                    }
                });
                this.fetchNextTask();
            },

            async handleBack(e) {
                e.preventDefault();
                if (!this.currentTask) { window.location.href = 'content-labelling.html'; return; }
                if (confirm("âš ï¸ Release task back to queue?")) { this.isSubmitting = true; await this.releaseCurrentTask(); window.location.href = 'content-labelling.html'; }
            },
            async releaseCurrentTask() { if(!this.currentTask) return; try { await fetch('/api/video-tasks', { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: this.currentTask.internal_id }) }); } catch(e) {} },

            startTimer() { this.stopTimer(); this.timer = 0; this.updateTimerDisplay(); this.timerInterval = setInterval(() => { this.timer++; this.updateTimerDisplay(); }, 1000); },
            updateTimerDisplay() { const d = new Date(null); d.setSeconds(this.timer); if(document.getElementById('timer')) document.getElementById('timer').innerText = d.toISOString().substr(11, 8); },
            stopTimer() { if (this.timerInterval) { clearInterval(this.timerInterval); this.timerInterval = null; } },

            formatDuration(seconds) { if(!seconds || isNaN(seconds)) return "00:00:00"; const secNum = parseInt(seconds, 10); const h = Math.floor(secNum / 3600); const m = Math.floor((secNum - h * 3600) / 60); const s = secNum - h * 3600 - m * 60; return `${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`; },
            copyText(id) { const el = document.getElementById(id); const txt = el.getAttribute('data-full') || el.innerText; if(txt && txt!=='--') navigator.clipboard.writeText(txt); },

            // --- TAGGING ---
            handleTagInput(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const val = e.target.value.trim();
                    if (val && !this.tags.includes(val)) {
                        this.tags.push(val);
                        this.renderTags();
                        e.target.value = '';
                    }
                } else if (e.key === 'Backspace' && e.target.value === '' && this.tags.length > 0) {
                    this.tags.pop();
                    this.renderTags();
                }
            },
            renderTags() {
                const wrapper = document.getElementById('tags-container');
                wrapper.innerHTML = this.tags.map((t, i) => `<div class="tag-chip">${t}<span class="tag-remove" onclick="VideoApp.removeTag(${i})">Ã—</span></div>`).join('');
            },
            removeTag(index) { this.tags.splice(index, 1); this.renderTags(); },

            uploadCSV(input) {
                const file = input.files[0]; if(!file) return;
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: async function(results) {
                    const tasks = []; results.data.forEach(row => { if (row.id && row.raw_media_url) tasks.push({ id: row.id.trim(), tenant: row.tenant||'', title: row.title||'', content: row.content||'', created_by: row.created_by||'', created_time: row.created_time||'', video_uid: row.video_uid||'', video_duration: row.video_duration||'', raw_media_url: row.raw_media_url.trim() }); });
                    if (tasks.length === 0) { alert("âŒ No valid rows."); return; }
                    if (!confirm(`Ready to upload ${tasks.length} tasks.`)) return;
                    try { const res = await fetch('/api/video-tasks', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ tasks }) }); if(res.ok) { alert("âœ… Uploaded!"); VideoApp.fetchNextTask(); } else alert("Upload failed."); } catch(err) { alert("Network Error"); }
                }, error: function(err) { alert("CSV Error"); } });
            },

            async exportAndWipe() { if(!confirm("âš ï¸ Download & Delete?")) return; try { const res = await fetch('/api/video-tasks', { method: 'DELETE' }); if(res.status===404){alert("Empty.");return;} if(!res.ok)throw new Error("Failed"); const b=await res.blob(); const u=window.URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=`batch_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); alert("âœ… Done!"); location.reload(); } catch(e){alert("Error");} },

            async fetchNextTask() {
                document.getElementById('loader').style.display = 'flex'; document.getElementById('workbench').style.display = 'none'; document.getElementById('empty-state').style.display = 'none';
                this.selectedLabel = null; document.querySelectorAll('.label-btn').forEach(b => b.classList.remove('active'));
                this.tags = []; this.renderTags();

                try { const res = await fetch(`/api/video-tasks?username=${this.currentUser.username}`); const data = await res.json();
                    if(data.task) { this.renderTask(data.task); this.startTimer(); } else { document.getElementById('loader').style.display = 'none'; document.getElementById('empty-state').style.display = 'flex'; this.stopTimer(); }
                } catch(err) { document.getElementById('error-msg').innerText = err.message; document.getElementById('retry-btn').style.display = 'block'; }
            },

            renderTask(task) {
                this.currentTask = task;
                const setVal = (id, val, full) => { const el = document.getElementById(id); el.innerText = val||'--'; el.setAttribute('data-full', full||val); };
                setVal('info-id', task.source_id); setVal('info-tenant', task.tenant); setVal('info-duration', this.formatDuration(task.video_duration));
                setVal('info-creator', task.created_by); setVal('info-time', task.created_time);
                
                const shortUid = task.video_uid ? (task.video_uid.length > 10 ? task.video_uid.substring(0, 10)+"..." : task.video_uid) : '--';
                setVal('info-uid', shortUid, task.video_uid);

                document.getElementById('text-top').innerText = task.title || "No Title"; document.getElementById('text-bottom').innerText = task.content || "";
                const vid = document.getElementById('main-video'); vid.src = task.raw_media_url; vid.load(); vid.play().catch(()=>{});
                
                setTimeout(() => { document.getElementById('loader').style.display = 'none'; document.getElementById('workbench').style.display = 'grid'; }, 500);
            },

            selectLabel(btn, label) { document.querySelectorAll('.label-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); this.selectedLabel = label; },

            async submit(isLeaving) {
                if(!this.selectedLabel) { alert("Please select a category"); return; }
                this.isSubmitting = true;
                const finalRemarks = `Tags: ${this.tags.join(', ')}`;

                try { const res = await fetch('/api/video-tasks', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: this.currentTask.internal_id, label: this.selectedLabel, remarks: finalRemarks }) });
                    if(res.ok) { this.count++; document.getElementById('session-counter').innerText = this.count; this.isSubmitting = false; if (isLeaving) { alert("âœ… Submitted."); window.location.href = 'content-labelling.html'; } else { this.fetchNextTask(); } }
                } catch(err) { this.isSubmitting = false; alert("Error submitting"); }
            }
        };
        window.addEventListener('DOMContentLoaded', () => VideoApp.init());
    </script>
</body>
</html>
