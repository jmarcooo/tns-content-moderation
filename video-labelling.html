<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Labelling Task (Shared Queue)</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        /* --- TYPOGRAPHY & GLOBAL --- */
        body, button, input, textarea, select {
            font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #24292f;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- LIGHT MODE VARIABLES --- */
        :root {
            --bg-body: #ffffff;
            --bg-canvas: #f6f8fa;
            --bg-card: #ffffff;
            --text-main: #24292f;
            --text-muted: #57606a;
            --border-color: #d0d7de;
            --accent-color: #0969da;
            --btn-sec-bg: #f6f8fa;
            --btn-sec-hover: #f3f4f6;
        }

        /* --- DARK MODE VARIABLES --- */
        body.dark-mode, [data-theme="dark"] {
            --bg-body: #0d1117;
            --bg-canvas: #161b22;
            --bg-card: #161b22;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --btn-sec-bg: #21262d;
            --btn-sec-hover: #30363d;
        }

        /* Apply Theme */
        body { background-color: var(--bg-body); color: var(--text-main); }

        .timer-badge { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 0.95rem; font-weight: 600; color: var(--text-main); }
        .content-canvas { display: flex; flex-direction: column; height: 100%; overflow-y: auto; padding: 24px 32px; background-color: var(--bg-body); }
        
        /* --- LAYOUT --- */
        .split-view { display: flex; gap: 24px; align-items: flex-start; height: 100%; }
        .video-column { flex: 3; display: flex; flex-direction: column; gap: 20px; }
        .video-wrapper { background: black; border-radius: 8px; overflow: hidden; aspect-ratio: 16/9; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .context-box { 
            background-color: var(--bg-canvas); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; padding: 20px; 
        }
        
        .action-column { 
            flex: 2; 
            background: var(--bg-card); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; padding: 20px; 
            display: flex; flex-direction: column; gap: 20px; height: 100%; 
        }

        /* --- SIDEBAR INFO CARDS --- */
        .info-card { 
            background: var(--bg-card); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            padding: 16px; 
            margin-bottom: 16px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .info-header { 
            font-weight: 700; 
            color: var(--text-main); 
            margin-bottom: 12px; 
            font-size: 0.95rem; 
        }
        .info-row { 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.9rem; 
            margin-bottom: 10px; 
            align-items: center; 
        }
        .info-row .label { color: var(--text-muted); font-weight: 500; }
        
        .info-row .value { 
            color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: 400;
            text-align: right; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 130px; 
        }

        /* Special smaller font for Time to fit completely */
        #info-time {
            font-size: 0.78rem; 
            font-family: 'SFMono-Regular', Consolas, monospace;
            letter-spacing: -0.3px;
        }
        
        /* --- ICONS (SVG) --- */
        .icon-svg { width: 16px; height: 16px; vertical-align: middle; }
        
        /* --- COPY BUTTON (MOVED TO LEFT) --- */
        .copy-btn {
            background: none; 
            border: none; 
            cursor: pointer; 
            padding: 4px;
            color: var(--text-muted); 
            border-radius: 4px; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px; /* Space between icon and text */
        }
        .copy-btn:hover { background-color: var(--bg-canvas); color: var(--accent-color); }
        .copy-btn svg { width: 14px; height: 14px; stroke-width: 2; }

        .value-wrapper { display: flex; align-items: center; justify-content: flex-end; }

        /* --- BUTTONS --- */
        .labelling-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .btn-label { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 10px 16px; 
            background-color: var(--bg-card); 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            cursor: pointer; font-size: 0.95rem; font-weight: 500; 
            color: var(--text-main); transition: all 0.2s; text-align: left; 
        }
        .btn-label:hover { border-color: var(--accent-color); background-color: var(--bg-canvas); }
        .btn-label.selected { background-color: rgba(9, 105, 218, 0.1); border-color: var(--accent-color); color: var(--accent-color); }
        
        .check-icon { width: 18px; height: 18px; border: 2px solid var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--bg-card); transition: all 0.2s;}
        .btn-label.selected .check-icon { border-color: var(--accent-color); background-color: var(--accent-color); }
        .check-icon svg { width: 10px; height: 10px; fill: white; display: none; }
        .btn-label.selected .check-icon svg { display: block; }
        
        .labelling-textarea { 
            width: 100%; padding: 12px; border: 1px solid var(--border-color); 
            border-radius: 6px; background-color: var(--bg-card); 
            color: var(--text-main); font-size: 0.9rem; resize: vertical; 
            min-height: 100px; outline: none; transition: border 0.2s;
        }
        .labelling-textarea:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(9,105,218,0.1); }
        .text-field-label { margin-bottom:8px; font-weight:600; color:var(--text-main); font-size:0.85rem; display: block;}
        
        /* HEADER BUTTONS */
        .btn-header { 
            color: white; border: none; padding: 8px 16px; border-radius: 6px; 
            font-size: 0.9rem; font-weight: 500; cursor: pointer; 
            display: flex; align-items: center; gap: 8px; text-decoration: none; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .btn-upload { background-color: #238636; }
        .btn-upload:hover { background-color: #2ea043; }
        .btn-export { background-color: #cf222e; margin-left: 10px; }
        .btn-export:hover { background-color: #d93f48; }
        
        .btn-secondary { 
            background-color: var(--btn-sec-bg); color: var(--text-main); 
            border: 1px solid var(--border-color); padding: 10px; 
            border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1; transition: all 0.2s; 
        }
        .btn-primary { 
            background-color: #1f883d; color: white; border: none; padding: 10px; 
            border-radius: 6px; cursor: pointer; font-weight: 600; flex: 2; transition: all 0.2s; 
        }
        .btn-secondary:hover { background-color: var(--btn-sec-hover); border-color: #8b949e; }
        .btn-primary:hover { background-color: #1a7f37; }
        .action-row { display: flex; gap: 12px; margin-top: auto; }

        /* HEADER TITLE & LINKS */
        #queue-title { color: var(--text-main); margin: 0; margin-right: 20px; font-size: 1.6rem; letter-spacing: -0.5px; }
        .header-link { text-decoration: none; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .header-link:hover { color: var(--accent-color); }
    </style>
</head>
<body>

    <script src="sidebar.js"></script>

    <main class="main-content">
        <div class="header" style="margin-bottom: 20px; border-bottom: none; padding-bottom: 0;">
            <div>
                <a href="#" onclick="VideoApp.handleBack(event)" class="header-link">
                    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Back to Queue
                </a>
                <div style="display:flex; align-items:center; margin-top: 10px;">
                    <h1 id="queue-title">Video Labelling</h1>
                    <div id="adminControls" style="display:none; align-items:center;">
                        
                        <button class="btn-header btn-upload" onclick="document.getElementById('csvInput').click()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-svg"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            Upload
                        </button>
                        <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="VideoApp.uploadCSV(this)">
                        
                        <button class="btn-header btn-export" onclick="VideoApp.exportAndWipe()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-svg"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Batch Download & Wipe DB
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 20px; align-items: center;">
                <span style="font-size:0.9rem; color: var(--text-muted);">Session Time: <span id="timer" class="timer-badge">00:00:00</span></span>
                <span style="font-size:0.9rem; color: var(--text-muted);">My Count: <span id="session-counter" style="color:var(--text-main); font-weight:bold;">0</span></span>
            </div>
        </div>

        <div id="loader" style="display: flex; flex-direction:column; justify-content: center; align-items: center; height: 60vh; font-size: 1.1rem; color: var(--text-muted);">
            <div id="loader-text" style="margin-bottom: 10px;">âš¡ Fetching task...</div>
            <div id="error-msg" style="color:#cf222e; margin-top:10px; display:none; max-width: 400px; text-align: center; font-size: 0.9rem;"></div>
            <button id="retry-btn" onclick="VideoApp.fetchNextTask()" style="margin-top:15px; padding:8px 16px; cursor:pointer; display:none; border:1px solid var(--border-color); background:var(--bg-card); color:var(--text-main); border-radius:6px;">Retry</button>
        </div>
        
        <div id="empty-state" style="display: none; flex-direction:column; justify-content: center; align-items: center; height: 60vh; color: var(--text-muted);">
            <div style="font-size: 3rem; margin-bottom: 10px;">ðŸŽ‰</div>
            <h2 style="margin: 0; color: var(--text-main);">Queue Empty</h2>
            <p style="margin-top: 5px;">Waiting for new batch upload.</p>
            <button onclick="VideoApp.fetchNextTask()" style="margin-top:20px; padding:8px 20px; background:var(--bg-canvas); border:1px solid var(--border-color); border-radius:6px; cursor:pointer; font-weight:600; color:var(--text-main);">Refresh</button>
        </div>

        <div id="workbench" class="workbench-container" style="display: none; align-items: flex-start; gap: 24px;">
            <div class="left-sidebar" style="width: 280px; flex-shrink:0;">
                
                <div class="info-card">
                    <div class="info-header">Task Details</div>
                    <div class="info-row">
                        <span class="label">Post ID:</span> 
                        <div class="value-wrapper">
                            <button class="copy-btn" onclick="VideoApp.copyText('info-id')" title="Copy ID">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                            </button>
                            <span class="value" id="info-id">--</span>
                        </div>
                    </div>
                    <div class="info-row"><span class="label">Tenant:</span> <span class="value" id="info-tenant">--</span></div>
                    <div class="info-row"><span class="label">Duration:</span> <span class="value" id="info-duration">--</span></div>
                </div>

                <div class="info-card">
                    <div class="info-header">Source Info</div>
                    <div class="info-row">
                        <span class="label">Created by:</span> 
                        <div class="value-wrapper">
                            <button class="copy-btn" onclick="VideoApp.copyText('info-creator')" title="Copy Creator">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                            </button>
                            <span class="value" id="info-creator">--</span>
                        </div>
                    </div>
                    <div class="info-row"><span class="label">Time:</span> <span class="value" id="info-time">--</span></div>
                    <div class="info-row">
                        <span class="label">Video UID:</span> 
                        <div class="value-wrapper">
                            <button class="copy-btn" onclick="VideoApp.copyText('info-uid')" title="Copy UID">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                            </button>
                            <span class="value" id="info-uid" title="">--</span>
                        </div>
                    </div>
                </div>

            </div>

            <div class="content-canvas" style="background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; flex-grow: 1;">
                
                <div class="split-view">
                    
                    <div class="video-column">
                        <div class="section-header" style="font-weight: 700; font-size: 0.85rem; color: var(--text-main); text-transform: uppercase;">VIDEO CONTENT</div>
                        <div class="video-wrapper">
                            <video id="main-video" controls autoplay style="width:100%; height:100%; display:block;"></video>
                        </div>

                        <div class="context-box">
                            <div class="text-field-label" style="font-size: 1rem; margin-bottom: 8px;">Video Title</div>
                            <div id="text-top" style="margin-bottom: 20px; font-weight: 400; color: var(--text-main); font-size: 1rem;"></div>
                            
                            <div class="text-field-label">Content / Description</div>
                            <div id="text-bottom" style="color: var(--text-muted); line-height: 1.6;"></div>
                        </div>
                    </div>

                    <div class="action-column">
                        <div class="section-header" style="font-weight: 700; font-size: 0.85rem; color: var(--text-main); text-transform: uppercase;">CATEGORIZATION</div>
                        
                        <div class="labelling-grid">
                            <button class="btn-label" onclick="VideoApp.selectLabel(this, 'Safe')"><span>Safe</span><div class="check-icon">âœ“</div></button>
                            <button class="btn-label" onclick="VideoApp.selectLabel(this, 'Low Risk')"><span>Low Risk</span><div class="check-icon">âœ“</div></button>
                            <button class="btn-label" onclick="VideoApp.selectLabel(this, 'High Risk')"><span>High Risk</span><div class="check-icon">âœ“</div></button>
                            <button class="btn-label" onclick="VideoApp.selectLabel(this, 'Critical')"><span>Critical</span><div class="check-icon">âœ“</div></button>
                        </div>

                        <div style="margin-top: 10px; flex-grow: 1;">
                            <label class="text-field-label">Remarks</label>
                            <textarea id="remarks" class="labelling-textarea" placeholder="Optional notes..."></textarea>
                        </div>

                        <div class="action-row">
                            <button onclick="VideoApp.submit(true)" class="btn-secondary">Save & Leave</button>
                            <button onclick="VideoApp.submit(false)" class="btn-primary">Submit & Next</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script>
        const VideoApp = {
            selectedLabel: null, timer: 0, timerInterval: null, count: 0, currentTask: null, currentUser: null, isSubmitting: false,
            
            init() {
                const userJson = localStorage.getItem('currentUser');
                if(!userJson) { window.location.href='login.html'; return; }
                this.currentUser = JSON.parse(userJson);
                if(this.currentUser.role === 'Admin') document.getElementById('adminControls').style.display = 'flex';
                
                // Dark Mode Detection (Auto apply if sidebar has toggle or system pref)
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-mode');
                }

                window.addEventListener('beforeunload', () => {
                    if (this.currentTask && !this.isSubmitting) {
                        fetch('/api/video-tasks', {
                            method: 'PATCH',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ id: this.currentTask.internal_id }),
                            keepalive: true
                        });
                    }
                });
                this.fetchNextTask();
            },

            async handleBack(e) {
                e.preventDefault();
                if (!this.currentTask) { window.location.href = 'content-labelling.html'; return; }
                if (confirm("âš ï¸ Release task back to queue?")) {
                    this.isSubmitting = true; await this.releaseCurrentTask(); window.location.href = 'content-labelling.html';
                }
            },

            async releaseCurrentTask() {
                if(!this.currentTask) return;
                try {
                    await fetch('/api/video-tasks', {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id: this.currentTask.internal_id })
                    });
                } catch(e) { console.error("Release failed", e); }
            },

            startTimer() {
                if (this.timerInterval) return; 
                this.timerInterval = setInterval(() => {
                    this.timer++;
                    const d = new Date(null); d.setSeconds(this.timer);
                    if(document.getElementById('timer')) document.getElementById('timer').innerText = d.toISOString().substr(11, 8);
                }, 1000);
            },
            stopTimer() {
                if (this.timerInterval) { clearInterval(this.timerInterval); this.timerInterval = null; }
            },

            formatDuration(seconds) {
                if(!seconds || isNaN(seconds)) return "00:00:00";
                const secNum = parseInt(seconds, 10);
                const hours   = Math.floor(secNum / 3600);
                const minutes = Math.floor((secNum - (hours * 3600)) / 60);
                const secs    = secNum - (hours * 3600) - (minutes * 60);
                const hDisplay = hours < 10 ? "0"+hours : hours;
                const mDisplay = minutes < 10 ? "0"+minutes : minutes;
                const sDisplay = secs < 10 ? "0"+secs : secs;
                return `${hDisplay}:${mDisplay}:${sDisplay}`;
            },

            copyText(elementId) {
                const el = document.getElementById(elementId);
                const text = el.getAttribute('data-full') || el.innerText;
                
                if(text && text !== '--') {
                    navigator.clipboard.writeText(text).then(() => {
                        const btn = el.previousElementSibling; // Button is now previous sibling
                        const originalInnerHTML = btn.innerHTML;
                        // Show Checkmark SVG temporarily
                        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="#2da44e" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
                        setTimeout(() => btn.innerHTML = originalInnerHTML, 1500);
                    });
                }
            },

            uploadCSV(input) {
                const file = input.files[0];
                if(!file) return;

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async function(results) {
                        const rawData = results.data;
                        const tasks = [];
                        let skippedCount = 0;

                        rawData.forEach(row => {
                            if (row.id && row.raw_media_url) {
                                tasks.push({
                                    id: row.id.trim(),
                                    tenant: row.tenant || '',
                                    title: row.title || '',
                                    content: row.content || '',
                                    created_by: row.created_by || '',
                                    created_time: row.created_time || '',
                                    video_uid: row.video_uid || '',
                                    video_duration: row.video_duration || '',
                                    raw_media_url: row.raw_media_url.trim()
                                });
                            } else { skippedCount++; }
                        });

                        if (tasks.length === 0) { alert("âŒ No valid rows found. Check headers."); return; }
                        
                        let confirmMsg = `Ready to upload ${tasks.length} tasks.`;
                        if (skippedCount > 0) confirmMsg += `\n(Skipped ${skippedCount} invalid rows)`;
                        
                        if (!confirm(confirmMsg)) return;

                        try {
                            const res = await fetch('/api/video-tasks', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ tasks })
                            });
                            if(res.ok) {
                                alert(`âœ… Successfully uploaded ${tasks.length} tasks!`);
                                VideoApp.fetchNextTask();
                            } else {
                                const err = await res.json();
                                alert("Upload failed: " + (err.error || "Unknown error"));
                            }
                        } catch(err) { alert("Network Error: " + err.message); }
                    },
                    error: function(err) { alert("CSV Parsing Error: " + err.message); }
                });
            },

            async exportAndWipe() {
                if(!confirm("âš ï¸ Download results & Clear Queue?")) return;
                try {
                    const res = await fetch('/api/video-tasks', { method: 'DELETE' });
                    if(res.status === 404) { alert("Database empty."); return; }
                    if(!res.ok) throw new Error("Export failed");
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `moderation_batch_${new Date().toISOString().slice(0,10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    alert("âœ… Done!");
                    location.reload(); 
                } catch(err) { alert("Error: " + err.message); }
            },

            async fetchNextTask() {
                document.getElementById('loader').style.display = 'flex';
                document.getElementById('workbench').style.display = 'none';
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('error-msg').style.display = 'none';
                document.getElementById('retry-btn').style.display = 'none';

                this.selectedLabel = null;
                document.querySelectorAll('.btn-label').forEach(b => b.classList.remove('selected'));
                document.getElementById('remarks').value = '';

                try {
                    const res = await fetch(`/api/video-tasks?username=${this.currentUser.username}`);
                    const data = await res.json();
                    
                    if(data.task) {
                        this.renderTask(data.task);
                        this.startTimer();
                    } else {
                        document.getElementById('loader').style.display = 'none';
                        document.getElementById('empty-state').style.display = 'flex';
                        this.stopTimer();
                    }
                } catch(err) { 
                    console.error(err);
                    document.getElementById('loader-text').innerText = 'âŒ Error';
                    document.getElementById('error-msg').style.display = 'block';
                    document.getElementById('error-msg').innerText = err.message;
                    document.getElementById('retry-btn').style.display = 'block';
                }
            },

            renderTask(task) {
                this.currentTask = task; 
                
                // RENDER SIDEBAR
                const idEl = document.getElementById('info-id');
                idEl.innerText = task.source_id || '--';
                idEl.setAttribute('data-full', task.source_id); 
                
                document.getElementById('info-tenant').innerText = task.tenant || '--';
                document.getElementById('info-duration').innerText = this.formatDuration(task.video_duration);
                
                const creatorEl = document.getElementById('info-creator');
                creatorEl.innerText = task.created_by || '--';
                creatorEl.setAttribute('data-full', task.created_by);

                document.getElementById('info-time').innerText = task.created_time || '--';
                
                const uid = task.video_uid || '--';
                const shortUid = uid.length > 10 ? uid.substring(0, 10) + "..." : uid;
                const uidEl = document.getElementById('info-uid');
                uidEl.innerText = shortUid;
                uidEl.title = uid; 
                uidEl.setAttribute('data-full', uid); 

                document.getElementById('text-top').innerText = task.title || "No Title";
                document.getElementById('text-bottom').innerText = task.content || "";
                
                const vid = document.getElementById('main-video');
                vid.src = task.raw_media_url;
                vid.load();
                vid.play().catch(e => console.log("Autoplay blocked:", e));

                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('workbench').style.display = 'flex';
                }, 500);
            },
            
            selectLabel(btn, label) {
                document.querySelectorAll('.btn-label').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                this.selectedLabel = label;
            },

            async submit(isLeaving) {
                if(!this.selectedLabel) { alert("Please select a category"); return; }
                this.isSubmitting = true;

                try {
                    const res = await fetch('/api/video-tasks', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            id: this.currentTask.internal_id, 
                            label: this.selectedLabel,
                            remarks: document.getElementById('remarks').value
                        })
                    });
                    if(res.ok) {
                        this.count++;
                        document.getElementById('session-counter').innerText = this.count;
                        this.isSubmitting = false;
                        if (isLeaving) {
                            alert("âœ… Saved. Returning to dashboard.");
                            window.location.href = 'content-labelling.html';
                        } else {
                            this.fetchNextTask();
                        }
                    }
                } catch(err) { 
                    this.isSubmitting = false; 
                    alert("Error submitting"); 
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => VideoApp.init());
    </script>
</body>
</html>
