<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Labelling Task (Shared Queue)</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        .timer-badge { font-family: monospace; font-size: 1rem; letter-spacing: 1px; font-weight: bold; }
        .content-canvas { display: flex; flex-direction: column; height: 100%; overflow-y: auto; padding: 30px; }
        
        /* LAYOUT */
        .split-view { display: flex; gap: 24px; align-items: flex-start; height: 100%; }
        .video-column { flex: 3; display: flex; flex-direction: column; gap: 20px; }
        .video-wrapper { background: black; border-radius: 8px; overflow: hidden; aspect-ratio: 16/9; width: 100%; }
        .context-box { background-color: #f6f8fa; border: 1px solid #d0d7de; border-radius: 8px; padding: 15px; }
        .action-column { flex: 2; background: white; border: 1px solid #d0d7de; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 20px; height: 100%; }

        /* BUTTONS & INPUTS */
        .labelling-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .btn-label { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background-color: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 600; color: #57606a; transition: all 0.2s; text-align: left; }
        .btn-label:hover { border-color: #0969da; background-color: #f1f8ff; color: #24292f; }
        .btn-label.selected { background-color: rgba(9, 105, 218, 0.1); border-color: #0969da; color: #0969da; box-shadow: 0 0 0 1px #0969da; }
        .check-icon { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-label.selected .check-icon { border-color: #0969da; background-color: #0969da; }
        .check-icon svg { width: 12px; height: 12px; fill: white; display: none; }
        .btn-label.selected .check-icon svg { display: block; }
        .labelling-textarea { width: 100%; padding: 12px; border: 1px solid #d0d7de; border-radius: 6px; background-color: #ffffff; color: #24292f; font-size: 0.9rem; resize: vertical; min-height: 120px; outline: none; font-family: inherit; }
        .text-field-label { margin-bottom:6px; font-weight:bold; color:#24292f; font-size:0.85rem; display: block;}
        
        .btn-header { color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; text-decoration: none; }
        .btn-upload { background-color: #238636; }
        .btn-upload:hover { background-color: #1f732d; }
        .btn-export { background-color: #cf222e; margin-left: 10px; }
        .btn-export:hover { background-color: #a40e26; }
        .btn-secondary { background-color: #6e7781; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; flex: 1;}
        .btn-primary { background-color: #2da44e; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; flex: 2;}
        .action-row { display: flex; gap: 10px; margin-top: auto; }
    </style>
</head>
<body>

    <script src="sidebar.js"></script>

    <main class="main-content">
        <div class="header" style="margin-bottom: 20px; border-bottom: none; padding-bottom: 0;">
            <div>
                <a href="#" onclick="VideoApp.handleBack(event)" style="text-decoration: none; color: #57606a; font-size: 0.9rem;">‚Üê Back to Queue</a>
                <div style="display:flex; align-items:center; margin-top: 5px;">
                    <h1 id="queue-title" style="margin:0; margin-right: 15px;">Video Labelling</h1>
                    <div id="adminControls" style="display:none; align-items:center;">
                        <button class="btn-header btn-upload" onclick="document.getElementById('csvInput').click()">
                            ‚òÅÔ∏è Upload Batch
                        </button>
                        <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="VideoApp.uploadCSV(this)">
                        <button class="btn-header btn-export" onclick="VideoApp.exportAndWipe()">
                            üì• Download & Wipe DB
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: center;">
                <span class="badge status-Active" style="font-size:0.9rem;">Session Time: <span id="timer" class="timer-badge">00:00:00</span></span>
                <span class="badge" style="background-color: #f6f8fa; border: 1px solid #d0d7de; color: #24292f; font-size:0.9rem;">
                    My Count: <span id="session-counter" style="font-weight:bold;">0</span>
                </span>
            </div>
        </div>

        <div id="loader" style="display: flex; flex-direction:column; justify-content: center; align-items: center; height: 60vh; font-size: 1.2rem; color: #57606a;">
            <div id="loader-text">‚ö° Fetching task from database...</div>
            <div id="error-msg" style="color:red; margin-top:15px; display:none; max-width: 400px; text-align: center;"></div>
            <button id="retry-btn" onclick="VideoApp.fetchNextTask()" style="margin-top:15px; padding:8px 16px; cursor:pointer; display:none;">Retry</button>
        </div>
        
        <div id="empty-state" style="display: none; flex-direction:column; justify-content: center; align-items: center; height: 60vh; color: #57606a;">
            <div style="font-size: 3rem;">üéâ</div>
            <h2 style="margin: 10px 0;">Queue Empty</h2>
            <p>Waiting for new batch upload.</p>
            <button onclick="VideoApp.fetchNextTask()" style="margin-top:20px; padding:10px 20px; cursor:pointer;">Refresh</button>
        </div>

        <div id="workbench" class="workbench-container" style="display: none; align-items: flex-start; gap: 24px;">
            <div class="left-sidebar" style="width: 280px; flex-shrink:0;">
                <div class="info-card">
                    <div class="info-header">Task Info</div>
                    <div class="info-row"><span class="label">ID:</span> <span class="value" id="info-id">--</span></div>
                    <div class="info-row"><span class="label">Tenant:</span> <span class="value" id="info-tenant">--</span></div>
                    <div class="info-row"><span class="label">Duration:</span> <span class="value" id="info-duration">--</span></div>
                </div>
                <div class="info-card">
                    <div class="info-header">Source Info</div>
                    <div class="info-row"><span class="label">Created By:</span> <span class="value" id="info-creator">--</span></div>
                    <div class="info-row"><span class="label">Time:</span> <span class="value" id="info-time">--</span></div>
                    <div class="info-row"><span class="label">Video UID:</span> <span class="value" id="info-uid" style="font-size:0.8rem">--</span></div>
                </div>
            </div>

            <div class="content-canvas" style="background-color: #ffffff; border: 1px solid #d0d7de; border-radius: 8px; flex-grow: 1;">
                
                <div class="split-view">
                    
                    <div class="video-column">
                        <div class="section-header">VIDEO CONTENT</div>
                        <div class="video-wrapper">
                            <video id="main-video" controls autoplay style="width:100%; height:100%; display:block;"></video>
                        </div>

                        <div class="context-box">
                            <div class="text-field-label">Video Title</div>
                            <div id="text-top" style="margin-bottom: 10px; font-weight: 500;"></div>
                            
                            <div class="text-field-label">Content / Description</div>
                            <div id="text-bottom" style="color: #57606a;"></div>
                        </div>
                    </div>

                    <div class="action-column">
                        <div class="section-header">CATEGORIZATION</div>
                        
                        <div class="labelling-grid">
                            <button class="btn-label" onclick="VideoApp.selectLabel(this, 'Safe')"><span>Safe</span><div class="check-icon">‚úì</div></button>
                            <button class="btn-label" onclick="VideoApp.selectLabel(this, 'Low Risk')"><span>Low Risk</span><div class="check-icon">‚úì</div></button>
                            <button class="btn-label" onclick="VideoApp.selectLabel(this, 'High Risk')"><span>High Risk</span><div class="check-icon">‚úì</div></button>
                            <button class="btn-label" onclick="VideoApp.selectLabel(this, 'Critical')"><span>Critical</span><div class="check-icon">‚úì</div></button>
                        </div>

                        <div style="margin-top: 10px; flex-grow: 1;">
                            <label class="text-field-label">Remarks</label>
                            <textarea id="remarks" class="labelling-textarea" placeholder="Add moderation notes here..."></textarea>
                        </div>

                        <div class="action-row">
                            <button onclick="VideoApp.submit(true)" class="btn-secondary">Save & Leave</button>
                            <button onclick="VideoApp.submit(false)" class="btn-primary">Submit & Next</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script>
        const VideoApp = {
            selectedLabel: null, timer: 0, timerInterval: null, count: 0, currentTask: null, currentUser: null, isSubmitting: false,
            
            init() {
                const userJson = localStorage.getItem('currentUser');
                if(!userJson) { window.location.href='login.html'; return; }
                this.currentUser = JSON.parse(userJson);
                if(this.currentUser.role === 'Admin') document.getElementById('adminControls').style.display = 'flex';
                
                window.addEventListener('beforeunload', () => {
                    if (this.currentTask && !this.isSubmitting) {
                        fetch('/api/video-tasks', {
                            method: 'PATCH',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ id: this.currentTask.internal_id }),
                            keepalive: true
                        });
                    }
                });
                this.fetchNextTask();
            },

            async handleBack(e) {
                e.preventDefault();
                if (!this.currentTask) { window.location.href = 'content-labelling.html'; return; }
                if (confirm("‚ö†Ô∏è Release task back to queue?")) {
                    this.isSubmitting = true; await this.releaseCurrentTask(); window.location.href = 'content-labelling.html';
                }
            },

            async releaseCurrentTask() {
                if(!this.currentTask) return;
                try {
                    await fetch('/api/video-tasks', {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id: this.currentTask.internal_id })
                    });
                } catch(e) { console.error("Release failed", e); }
            },

            startTimer() {
                if (this.timerInterval) return; 
                this.timerInterval = setInterval(() => {
                    this.timer++;
                    const d = new Date(null); d.setSeconds(this.timer);
                    if(document.getElementById('timer')) document.getElementById('timer').innerText = d.toISOString().substr(11, 8);
                }, 1000);
            },
            stopTimer() {
                if (this.timerInterval) { clearInterval(this.timerInterval); this.timerInterval = null; }
            },

            // --- ROBUST CSV PARSER (Powered by PapaParse) ---
            uploadCSV(input) {
                const file = input.files[0];
                if(!file) return;

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async function(results) {
                        // 1. Process Parsed Data
                        const rawData = results.data;
                        const tasks = [];
                        let skippedCount = 0;

                        rawData.forEach(row => {
                            // Check if essential fields exist (ID and URL)
                            if (row.id && row.raw_media_url) {
                                tasks.push({
                                    id: row.id.trim(),
                                    tenant: row.tenant || '',
                                    title: row.title || '',
                                    content: row.content || '',
                                    created_by: row.created_by || '',
                                    created_time: row.created_time || '',
                                    video_uid: row.video_uid || '',
                                    video_duration: row.video_duration || '',
                                    raw_media_url: row.raw_media_url.trim()
                                });
                            } else {
                                skippedCount++;
                            }
                        });

                        // 2. Validate Result
                        if (tasks.length === 0) {
                            alert("‚ùå No valid rows found.\nPlease ensure headers match: id, tenant, title, content, created_by, created_time, video_uid, video_duration, raw_media_url");
                            return;
                        }

                        // 3. Confirm with User if some rows skipped
                        let confirmMsg = `Ready to upload ${tasks.length} tasks.`;
                        if (skippedCount > 0) confirmMsg += `\n(Skipped ${skippedCount} invalid rows)`;
                        
                        if (!confirm(confirmMsg)) return;

                        // 4. Send to Backend
                        try {
                            const res = await fetch('/api/video-tasks', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ tasks })
                            });
                            if(res.ok) {
                                alert(`‚úÖ Successfully uploaded ${tasks.length} tasks!`);
                                VideoApp.fetchNextTask();
                            } else {
                                const err = await res.json();
                                alert("Upload failed: " + (err.error || "Unknown error"));
                            }
                        } catch(err) { alert("Network Error: " + err.message); }
                    },
                    error: function(err) {
                        alert("CSV Parsing Error: " + err.message);
                    }
                });
            },

            async exportAndWipe() {
                if(!confirm("‚ö†Ô∏è Download results & Clear Queue?")) return;
                try {
                    const res = await fetch('/api/video-tasks', { method: 'DELETE' });
                    if(res.status === 404) { alert("Database empty."); return; }
                    if(!res.ok) throw new Error("Export failed");
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `moderation_batch_${new Date().toISOString().slice(0,10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    alert("‚úÖ Done!");
                    location.reload(); 
                } catch(err) { alert("Error: " + err.message); }
            },

            async fetchNextTask() {
                document.getElementById('loader').style.display = 'flex';
                document.getElementById('workbench').style.display = 'none';
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('error-msg').style.display = 'none';
                document.getElementById('retry-btn').style.display = 'none';

                this.selectedLabel = null;
                document.querySelectorAll('.btn-label').forEach(b => b.classList.remove('selected'));
                document.getElementById('remarks').value = '';

                try {
                    const res = await fetch(`/api/video-tasks?username=${this.currentUser.username}`);
                    const data = await res.json();
                    
                    if(data.task) {
                        this.renderTask(data.task);
                        this.startTimer();
                    } else {
                        document.getElementById('loader').style.display = 'none';
                        document.getElementById('empty-state').style.display = 'flex';
                        this.stopTimer();
                    }
                } catch(err) { 
                    console.error(err);
                    document.getElementById('loader-text').innerText = '‚ùå Error';
                    document.getElementById('error-msg').style.display = 'block';
                    document.getElementById('error-msg').innerText = err.message;
                    document.getElementById('retry-btn').style.display = 'block';
                }
            },

            renderTask(task) {
                this.currentTask = task; 
                document.getElementById('info-id').innerText = task.source_id || '--';
                document.getElementById('info-tenant').innerText = task.tenant || '--';
                document.getElementById('info-duration').innerText = task.video_duration || '--';
                document.getElementById('info-creator').innerText = task.created_by || '--';
                document.getElementById('info-time').innerText = task.created_time || '--';
                document.getElementById('info-uid').innerText = task.video_uid || '--';

                document.getElementById('text-top').innerText = task.title || "No Title";
                document.getElementById('text-bottom').innerText = task.content || "";
                
                const vid = document.getElementById('main-video');
                vid.src = task.raw_media_url;
                vid.load();
                vid.play().catch(e => console.log("Autoplay blocked:", e));

                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('workbench').style.display = 'flex';
                }, 500);
            },

            selectLabel(btn, label) {
                document.querySelectorAll('.btn-label').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                this.selectedLabel = label;
            },

            async submit(isLeaving) {
                if(!this.selectedLabel) { alert("Please select a category"); return; }
                this.isSubmitting = true;

                try {
                    const res = await fetch('/api/video-tasks', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            id: this.currentTask.internal_id, 
                            label: this.selectedLabel,
                            remarks: document.getElementById('remarks').value
                        })
                    });
                    if(res.ok) {
                        this.count++;
                        document.getElementById('session-counter').innerText = this.count;
                        this.isSubmitting = false;
                        if (isLeaving) {
                            alert("‚úÖ Saved. Returning to dashboard.");
                            window.location.href = 'content-labelling.html';
                        } else {
                            this.fetchNextTask();
                        }
                    }
                } catch(err) { 
                    this.isSubmitting = false; 
                    alert("Error submitting"); 
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => VideoApp.init());
    </script>
</body>
</html>
